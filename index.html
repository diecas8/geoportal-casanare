<script>
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Actualizar control de capas
        overlayMaps["Nuevos Dibujos"] = drawnItems;
        actualizarControlCapas();

        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                remove: true
            },
            draw: {
                polyline: false,
                circle: false,
                rectangle: {
                    shapeOptions: {
                        color: 'blue'
                    }
                },
                polygon: {
                    shapeOptions: {
                        color: 'green'
                    }
                },
                marker: true
            }
        });
        map.addControl(drawControl);

        // Manejar la creación de nuevos elementos
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;

            // Atributos solicitados al usuario
            const tipo = e.layerType === 'marker' ? 'Cultivo' : 'Finca';
            const nombre = prompt(`Nombre del ${tipo}:`) || 'Sin nombre';
            const propietario = prompt(`Propietario del ${tipo}:`) || 'Sin propietario';
            let hectareas = 0;

            if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                hectareas = (area / 10000).toFixed(2); // Convertir m² a hectáreas
            }

            // Configurar propiedades del GeoJSON
            layer.feature = {
                type: 'Feature',
                properties: {
                    tipo: tipo,
                    nombre: nombre,
                    propietario: propietario,
                    hectareas: hectareas || 'N/A'
                },
                geometry: {}
            };

            // Vincular popup
            layer.bindPopup(`
                <b>Tipo:</b> ${tipo}<br>
                <b>Nombre:</b> ${nombre}<br>
                <b>Propietario:</b> ${propietario}<br>
                <b>Hectáreas:</b> ${hectareas}
            `);

            drawnItems.addLayer(layer);
        });

        // Exportar a GeoJSON
        function exportarGeoJSON() {
            const geojson = drawnItems.toGeoJSON();
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "nuevas_fincas_y_cultivos.geojson";
            link.click();
        }
    </script>
