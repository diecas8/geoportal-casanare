<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (mantener metadatos y hojas de estilo anteriores) ... -->
    <style>
        /* ... (estilos anteriores) ... */

        /* Mejorar leyenda */
        .legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 200px;
            font-size: 0.9em;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- ... (estructura HTML existente) ... -->

    <script>
        // Paleta de colores mejorada para cultivos
        const colorMap = {
            // Cultivos básicos
            'arroz': '#FFD700',
            'maíz': '#FFA500',
            'trigo': '#D2B48C',
            
            // Frutales
            'banano': '#32CD32',
            'plátano': '#228B22',
            'papaya': '#FF6347',
            
            // Cultivos industriales
            'café': '#8B4513',
            'cacao': '#A0522D',
            'palma aceite': '#CD853F',
            
            // Pastos
            'pasto limpio': '#7CFC00',
            'pasto arbolado': '#2E8B57',
            'pasto enmalezado': '#ADFF2F',
            
            // Default y otros
            'bosque de galería': '#2c6b23',
            'otros': '#A9A9A9'
        };

        // Función para obtener color único por cultivo
        function getCultivoColor(cultivoNombre) {
            const cultivo = cultivoNombre.toLowerCase().trim();
            return colorMap[cultivo] || generateUniqueColor(cultivo);
        }

        // Generar color único para cultivos no listados
        function generateUniqueColor(seed) {
            const hash = Array.from(seed).reduce((acc, char) => char.charCodeAt(0) + (acc << 6) + (acc << 16) - acc, 0);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        // Modificar la capa de cultivos
        function cargarCultivos() {
            fetch("cultivos.geojson")
                .then(response => response.json())
                .then(data => {
                    cultivosLayer = L.geoJSON(data, {
                        style: feature => ({
                            color: '#fff',
                            weight: 1,
                            fillColor: getCultivoColor(feature.properties.cultivo),
                            fillOpacity: 0.7
                        }),
                        onEachFeature: (feature, layer) => {
                            // ... (mantener popup y lógica existente) ...
                        }
                    });
                    
                    // Actualizar leyenda con todos los cultivos encontrados
                    updateLegend(data);
                });
        }

        // Leyenda dinámica
        function updateLegend(geojsonData) {
            const cultivosUnicos = [...new Set(geojsonData.features.map(f => f.properties.cultivo))];
            
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>Leyenda de Cultivos</h4>';
                
                cultivosUnicos.forEach(cultivo => {
                    const color = getCultivoColor(cultivo);
                    div.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background:${color}"></div>
                            <span>${cultivo}</span>
                        </div>
                    `;
                });
                
                return div;
            };
            
            if (map.legend) map.removeControl(map.legend);
            map.legend = legend.addTo(map);
        }

        // ... (resto del código existente) ...
    </script>
</body>
</html>
