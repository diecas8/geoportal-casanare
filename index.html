<!DOCTYPE html>
<html lang="es">
<head>
    <!-- METADATOS Y HOJAS DE ESTILO EXISTENTES -->
    <style>
        /* ... (estilos anteriores) ... */
        
        /* Spinner de carga */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Leyenda */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.5;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #666;
        }
    </style>
</head>
<body>
    <!-- ESTRUCTURA HTML EXISTENTE -->
    <div class="loader"></div> <!-- Nuevo spinner -->

    <script>
        // FUNCIONALIDAD MEJORADA
        
        // ========== MANEJO DE CARGA ==========
        function showLoader(show) {
            document.querySelector('.loader').style.display = show ? 'block' : 'none';
        }

        // ========== VALIDACIÓN AL DIBUJAR ==========
        function handleDrawValidation(layer, layerType) {
            let name = prompt(`Nombre del ${layerType === 'marker' ? 'cultivo' : 'finca'}:`);
            
            while (!name || name.trim() === '') {
                alert('El nombre no puede estar vacío');
                name = prompt(`Nombre del ${layerType}:`);
            }
            
            layer.feature = {
                type: 'Feature',
                properties: {
                    type: layerType === 'marker' ? 'Cultivo' : 'Finca',
                    name: name.trim()
                },
                geometry: {}
            };
            
            return layer;
        }

        // ========== LEYENDA INTERACTIVA ==========
        function addLegend() {
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<strong>Leyenda de Cultivos</strong>';
                
                Object.entries(colorMap).forEach(([cultivo, color]) => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background:${color}"></div>
                        <span>${cultivo}</span>
                    `;
                    div.appendChild(item);
                });
                
                return div;
            };
            
            legend.addTo(map);
        }

        // ========== CARGA SEGURA DE CAPAS ==========
        async function cargarCultivos() {
            showLoader(true);
            
            try {
                const response = await fetch("cultivos.geojson");
                if (!response.ok) throw new Error('Error en la red');
                
                const data = await response.json();
                // ... (código existente de cultivosLayer) ...
                
                addLegend(); // Añadir leyenda después de cargar
            } catch (error) {
                alert(`Error al cargar cultivos: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }

        // ========== MODIFICACIÓN EN EL DIBUJADO ==========
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            const layerType = e.layerType;
            
            const validatedLayer = handleDrawValidation(layer, layerType);
            if (validatedLayer) drawnItems.addLayer(validatedLayer);
        });

        // ... (resto del código existente) ...
    </script>
</body>
</html>
