<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal con Fincas y Cultivos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; }
        #map { flex: 1; }
        .sidebar {
            width: 350px;
            padding: 15px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .sidebar .export-container, .summary, .chart-container { margin-bottom: 20px; }
        .chart-container { background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Seleccionar Finca</h3>
        <select id="codigoFinca" onchange="filtrarPorFinca()">
            <option value="">Seleccione una finca</option>
        </select>
        <div id="summary" class="summary">
            <strong>Resumen:</strong>
            <p>Seleccione una finca para ver los detalles.</p>
        </div>
        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([5.5, -73.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let fincasLayer, cultivosLayer, chart, datosFincaSeleccionada = [];
        const colorMap = {
            'bosque': '#006400',
            'café': '#8B0000',
            'cacao': '#D2691E',
            'arroz': '#FFD700',
            'pasto': '#228B22',
            'plátano': '#32CD32',
            'otros': '#FF6347'
        };

        // Cargar capas de GeoJSON
        async function cargarGeoJSON() {
            try {
                const fincasResponse = await fetch('fincas.geojson');
                const cultivosResponse = await fetch('cultivos.geojson');

                const fincasData = await fincasResponse.json();
                const cultivosData = await cultivosResponse.json();

                cargarFincas(fincasData);
                cargarCultivos(cultivosData);
            } catch (error) {
                console.error("Error al cargar los GeoJSON:", error);
            }
        }

        // Cargar y renderizar fincas
        function cargarFincas(data) {
            fincasLayer = L.geoJSON(data, {
                style: { color: 'blue', weight: 2 },
                onEachFeature: (feature, layer) => {
                    const { cod_finca, nom_finca_, area } = feature.properties;
                    layer.bindPopup(`
                        <b>Finca:</b> ${nom_finca_}<br>
                        <b>Código:</b> ${cod_finca}<br>
                        <b>Área:</b> ${area} ha
                    `);
                }
            }).addTo(map);

            actualizarListaFincas(data.features);
        }

        // Cargar y renderizar cultivos
        function cargarCultivos(data) {
            cultivosLayer = L.geoJSON(data, {
                style: feature => ({
                    color: colorMap[feature.properties.cultivo?.toLowerCase()] || 'gray',
                    weight: 1,
                    fillOpacity: 0.5
                }),
                onEachFeature: (feature, layer) => {
                    const { cultivo, has, cod_finca } = feature.properties;
                    layer.bindPopup(`
                        <b>Cultivo:</b> ${cultivo}<br>
                        <b>Área:</b> ${has} ha<br>
                        <b>Finca Código:</b> ${cod_finca}
                    `);
                }
            }).addTo(map);
        }

        // Actualizar lista desplegable de fincas
        function actualizarListaFincas(fincas) {
            const select = document.getElementById('codigoFinca');
            fincas.forEach(finca => {
                const { cod_finca, nom_finca_ } = finca.properties;
                const option = document.createElement('option');
                option.value = cod_finca;
                option.textContent = `${cod_finca} - ${nom_finca_}`;
                select.appendChild(option);
            });
        }

        // Filtrar y mostrar detalles de finca seleccionada
        function filtrarPorFinca() {
            const codigoFinca = document.getElementById('codigoFinca').value;
            if (!codigoFinca) return;

            let totalArea = 0;
            const resumen = {};

            cultivosLayer.eachLayer(layer => {
                const { cod_finca, cultivo, has } = layer.feature.properties;
                if (cod_finca === codigoFinca) {
                    if (!resumen[cultivo]) resumen[cultivo] = 0;
                    resumen[cultivo] += parseFloat(has) || 0;
                    totalArea += parseFloat(has) || 0;
                    layer.setStyle({ fillOpacity: 0.8 });
                } else {
                    layer.setStyle({ fillOpacity: 0 });
                }
            });

            mostrarResumen(resumen, totalArea, codigoFinca);
            generarGrafico(Object.entries(resumen).map(([cultivo, hectareas]) => ({ Cultivo: cultivo, Hectareas: hectareas })));
        }

        // Mostrar resumen de finca seleccionada
        function mostrarResumen(resumen, totalArea, codigoFinca) {
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `<strong>Resumen:</strong><br>`;
            summaryDiv.innerHTML += `<b>Código de Finca:</b> ${codigoFinca}<br>`;
            summaryDiv.innerHTML += `<b>Área Total:</b> ${totalArea.toFixed(2)} ha<br><br>`;

            Object.entries(resumen).forEach(([cultivo, hectareas]) => {
                summaryDiv.innerHTML += `<b>${cultivo}:</b> ${hectareas.toFixed(2)} ha<br>`;
            });
        }

        // Generar gráfico de cultivos
        function generarGrafico(resumen) {
            const labels = resumen.map(item => item.Cultivo);
            const data = resumen.map(item => item.Hectareas);
            const backgroundColors = labels.map(label => colorMap[label.toLowerCase()] || 'gray');

            if (chart) chart.destroy();
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        cargarGeoJSON();
    </script>
</body>
</html>
