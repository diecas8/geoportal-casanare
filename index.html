<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Se mantienen los mismos enlaces a CSS y JS -->
    <style>
        /* Estilos anteriores + nuevos estilos para leyenda y loader */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.5;
        }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; margin-right: 8px; }
        
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader"></div>
    <!-- El mismo HTML anterior -->

    <script>
        // Función mejorada para manejar errores
        function manejarError(mensaje) {
            console.error(mensaje);
            alert(`Error: ${mensaje}`);
            document.querySelector('.loader').style.display = 'none';
        }

        // Función modificada para validar datos al dibujar
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            let nombre = '';
            let tipo = '';

            try {
                if (e.layerType === 'marker') {
                    tipo = 'Cultivo';
                    while (!nombre.trim()) {
                        nombre = prompt(`Nombre del ${tipo}:`);
                        if (nombre === null) break; // Si cancela, salir
                    }
                } else if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                    tipo = 'Finca';
                    while (!nombre.trim()) {
                        nombre = prompt(`Nombre de la ${tipo}:`);
                        if (nombre === null) break;
                    }
                }

                if (!nombre) {
                    map.removeLayer(layer);
                    throw new Error('Debe proporcionar un nombre válido');
                }

                layer.feature = {
                    type: 'Feature',
                    properties: {
                        type: tipo,
                        name: nombre,
                        fecha: new Date().toISOString().split('T')[0] // Nuevo campo
                    },
                    geometry: {}
                };

                drawnItems.addLayer(layer);
            } catch (error) {
                manejarError(error.message);
            }
        });

        // Función mejorada para cargar datos con loader
        async function cargarCultivos() {
            try {
                document.querySelector('.loader').style.display = 'block';
                const response = await fetch("cultivos.geojson");
                if (!response.ok) throw new Error('Error en la red');
                
                const data = await response.json();
                // Resto del código original...
                
                // Nueva función para añadir leyenda
                añadirLeyenda();
            } catch (error) {
                manejarError(`Error al cargar cultivos: ${error.message}`);
            } finally {
                document.querySelector('.loader').style.display = 'none';
            }
        }

        // Función para añadir leyenda interactiva
        function añadirLeyenda() {
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>Leyenda de Cultivos</h4>';
                
                Object.entries(colorMap).forEach(([cultivo, color]) => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background:${color}"></div>
                        <div>${cultivo}</div>
                    `;
                    div.appendChild(item);
                });

                return div;
            };
            legend.addTo(map);
        }

        // Resto del código original con las mismas funciones...
    </script>
</body>
</html>
