<script>
    // Mapa inicial
    var map = L.map('map').setView([5.3895, -72.3945], 7);

    // Crear capas base
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var satelite = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
    var blancoNegro = L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png');

    var baseMaps = { "OSM": osm, "Satelital": satelite, "Blanco y Negro": blancoNegro };
    L.control.layers(baseMaps).addTo(map);

    // URL del archivo GeoJSON
    var geoJsonUrl1 = 'fincasssss.geojson';

    // Variables globales
    var geojsonLayer, searchMarker;

    // Cargar archivo GeoJSON y añadirlo al mapa
    fetch(geoJsonUrl1)
        .then(response => response.json())
        .then(data => {
            geojsonLayer = L.geoJSON(data, {
                onEachFeature: onEachFeature,
                style: { color: "#ff7800", weight: 2, opacity: 0.8, fillOpacity: 0.4 }
            }).addTo(map);
        })
        .catch(error => console.error("Error al cargar el archivo GeoJSON:", error));

    // Función para buscar predios por código de finca
    function searchFinca() {
        var codFinca = document.getElementById('searchField').value.trim();
        if (!codFinca) {
            alert("Ingrese un código de finca.");
            return;
        }

        var found = false;
        geojsonLayer.eachLayer(function(layer) {
            if (layer.feature.properties.cod_finca === codFinca) {
                // Eliminar marcador de búsqueda anterior
                if (searchMarker) map.removeLayer(searchMarker);

                // Añadir un marcador en el centro del predio encontrado
                searchMarker = L.marker(layer.getBounds().getCenter(), {
                    icon: L.divIcon({
                        html: '<i class="fas fa-map-marker-alt" style="color: blue; font-size: 24px;"></i>',
                        className: 'custom-marker',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    })
                }).addTo(map).bindPopup("Resultado de búsqueda").openPopup();

                // Centrar el mapa en el predio encontrado y abrir su popup
                map.setView(layer.getBounds().getCenter(), 16);
                layer.openPopup();
                showFeatureInfo(layer.feature);
                found = true;
            }
        });
        if (!found) alert("No se encontró ningún predio con el código especificado.");
    }

    // Función para restablecer la vista inicial del mapa
    function resetView() {
        map.setView([5.3895, -72.3945], 7);
        if (searchMarker) map.removeLayer(searchMarker);
        document.getElementById('info').innerHTML = "Selecciona un predio en el mapa para ver detalles.";
    }

    // Función para mostrar la información de un predio en el sidebar
    function showFeatureInfo(feature) {
        var infoContent = `<strong>Detalles del Predio:</strong><br>`;
        for (let property in feature.properties) {
            infoContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
        }
        document.getElementById('info').innerHTML = infoContent;
    }

    // Manejo de cada predio en el GeoJSON y evento de clic para mostrar detalles
    function onEachFeature(feature, layer) {
        layer.on({
            click: function () {
                showFeatureInfo(feature);
            }
        });
        layer.bindPopup(`
            <strong>Predio:</strong> ${feature.properties.nom_finca || 'No disponible'}<br>
            <strong>Código Finca:</strong> ${feature.properties.cod_finca || 'No disponible'}<br>
            <strong>Propietario:</strong> ${feature.properties.propietario || 'No disponible'}
        `);
    }
</script>
