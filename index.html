<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal con Filtro de Cadena</title>
    <!-- Estilos de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Script de Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Script para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        #map { flex: 1; height: 100%; }
        .sidebar {
            width: 350px; padding: 15px; background-color: #f8f9fa; overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-right: 1px solid #ddd;
        }
        .filter, .summary, .chart-container { margin-bottom: 20px; }
        .filter select { width: 100%; padding: 5px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="filter">
            <label for="cadenaSelect"><strong>Seleccionar Cadena</strong></label>
            <select id="cadenaSelect" onchange="filtrarPorCadena()">
                <option value="">Seleccione una cadena</option>
            </select>
        </div>
        <div id="summary" class="summary">
            <strong>Resumen</strong>
            <p>Seleccione una cadena para ver los detalles.</p>
        </div>
    </div>
    <div id="map"></div>

    <script>
        // Configuración inicial del mapa
        const map = L.map('map').setView([5.5, -73.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

        let fincaLayer; // Capa de las fincas
        const cadenasDisponibles = new Set(); // Almacena las cadenas únicas
        const fincaData = []; // Almacena los datos procesados de la tabla

        // Función para cargar y procesar el archivo Excel
        function cargarExcel() {
            fetch('datos_fincas_completo.xlsx')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        // Procesar datos
                        sheet.forEach(row => {
                            const { Cadena, finca, cultivo, has, Propietario, Municipio } = row;
                            fincaData.push({ Cadena, finca, cultivo, has, Propietario, Municipio });

                            // Almacenar cadenas únicas
                            if (Cadena) cadenasDisponibles.add(Cadena);
                        });

                        // Crear filtro por cadena
                        llenarFiltroCadenas();

                        // Dibujar fincas en el mapa
                        dibujarFincas();
                    };
                    reader.readAsArrayBuffer(blob);
                })
                .catch(err => console.error('Error al cargar el archivo Excel:', err));
        }

        // Función para llenar el filtro de cadenas
        function llenarFiltroCadenas() {
            const cadenaSelect = document.getElementById("cadenaSelect");
            cadenasDisponibles.forEach(cadena => {
                const option = document.createElement("option");
                option.value = cadena;
                option.textContent = cadena;
                cadenaSelect.appendChild(option);
            });
        }

        // Función para dibujar fincas en el mapa
        function dibujarFincas() {
            fincaLayer = L.layerGroup();

            fincaData.forEach(row => {
                const { finca, cultivo, has, Propietario, Municipio } = row;

                // Crear marcador con información de la finca
                const marker = L.marker([Math.random() * 2 + 4, Math.random() * -2 - 72]) // Coordenadas aleatorias para ejemplo
                    .bindPopup(`
                        <b>Finca:</b> ${finca}<br>
                        <b>Cultivo:</b> ${cultivo}<br>
                        <b>Área:</b> ${parseFloat(has).toFixed(2)} ha<br>
                        <b>Propietario:</b> ${Propietario}<br>
                        <b>Municipio:</b> ${Municipio}
                    `);

                fincaLayer.addLayer(marker);
            });

            fincaLayer.addTo(map);
        }

        // Función para filtrar por cadena
        function filtrarPorCadena() {
            const cadenaSeleccionada = document.getElementById("cadenaSelect").value;

            if (cadenaSeleccionada) {
                fincaLayer.clearLayers();

                fincaData.forEach(row => {
                    const { finca, cultivo, has, Propietario, Municipio, Cadena } = row;

                    if (Cadena === cadenaSeleccionada) {
                        const marker = L.marker([Math.random() * 2 + 4, Math.random() * -2 - 72]) // Coordenadas aleatorias
                            .bindPopup(`
                                <b>Finca:</b> ${finca}<br>
                                <b>Cultivo:</b> ${cultivo}<br>
                                <b>Área:</b> ${parseFloat(has).toFixed(2)} ha<br>
                                <b>Propietario:</b> ${Propietario}<br>
                                <b>Municipio:</b> ${Municipio}
                            `);

                        fincaLayer.addLayer(marker);
                    }
                });

                fincaLayer.addTo(map);
            } else {
                fincaLayer.clearLayers();
                dibujarFincas();
            }
        }

        // Cargar el archivo Excel y procesar los datos al iniciar
        cargarExcel();
    </script>
</body>
</html>
