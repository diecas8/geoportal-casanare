<script>
    fetch("Cultivos.geojson")
        .then(response => response.ok ? response.json() : Promise.reject("No se pudo cargar el archivo GeoJSON de cultivos."))
        .then(data => {
            usosLayer = L.geoJSON(data, {
                style: estiloUsos,
                onEachFeature: (feature, layer) => {
                    const { cod_finca, nom_finca_, propietari, cultivo, has } = feature.properties;

                    // Usar el campo `propietari` para mostrar el nombre del propietario
                    layer.bindPopup(`
                        <b>Cultivo:</b> ${cultivo}<br>
                        <b>Área:</b> ${parseFloat(has).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ha<br>
                        <b>Propietario:</b> ${propietari || 'Sin información'}
                    `);

                    datosFincas.push({
                        Codigo: cod_finca,
                        Finca: nom_finca_,
                        Propietario: propietari || "Sin información",
                        Cultivo: cultivo,
                        Hectareas: has
                    });
                }
            }).addTo(map);
            cargarListaDesplegable(usosLayer);
        })
        .catch(error => alert(error));

    function filtrarPorFinca() {
        const codigoFinca = document.getElementById("codigoFinca").value;
        if (!codigoFinca) {
            alert("Seleccione una finca.");
            return;
        }

        let resumen = {}, totalArea = 0, propietario = "", nombreFinca = "", fincaBounds = L.latLngBounds();

        usosLayer.eachLayer(layer => {
            const { cod_finca, cultivo, has, propietari, nom_finca_ } = layer.feature.properties;
            if (cod_finca?.trim() === codigoFinca) {
                fincaBounds.extend(layer.getBounds());
                resumen[cultivo] = (resumen[cultivo] || 0) + parseFloat(has);
                totalArea += parseFloat(has);
                propietario = propietari || propietario;
                nombreFinca = nom_finca_ || nombreFinca;
            }
        });

        if (fincaBounds.isValid()) map.fitBounds(fincaBounds);
        else return alert("No se encontraron datos para esta finca.");

        const summaryDiv = document.getElementById("summary");
        summaryDiv.innerHTML = `
            <strong>Resumen de Cultivos para Finca ${codigoFinca}</strong><br>
            <b>Propietario:</b> ${propietario}<br>
            <b>Nombre de la Finca:</b> ${nombreFinca}<br>
            <b>Área Total:</b> ${totalArea.toFixed(2)} ha<br><br>
        `;

        for (let cultivo in resumen) {
            summaryDiv.innerHTML += `${cultivo}: ${resumen[cultivo].toFixed(2)} ha<br>`;
        }

        generarGrafico(resumen, codigoFinca);
    }
</script>
