<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Mejorado</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* ... (mantener todos los estilos anteriores) ... */
        
        /* Nuevos estilos para buscador */
        .select2-container--default .select2-selection--single {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            height: 34px !important;
        }
        .select2-container--default .select2-selection__arrow {
            height: 32px !important;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="CBS.png" alt="Logo" class="logo">
        <div class="filter">
            <label for="buscadorFincas"><strong>Buscar Finca</strong></label>
            <select id="buscadorFincas" class="form-control"></select>
        </div>
        <!-- ... (mantener resto del sidebar) ... -->
    </div>
    <div id="map"></div>
    <div class="loader"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>

    <script>
        // Configuración inicial del mapa (mantener igual)
        const map = L.map('map').setView([5.5, -73.0], 6);
        
        // Capas base (mantener igual)
        const baseMaps = { /* ... */ };

        // Mejora: Control de dibujo con cálculo de área
        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: {
                polygon: {
                    shapeOptions: { color: '#3388ff' },
                    showArea: true,
                    metric: true
                },
                // ... (resto de configuraciones de dibujo)
            }
        });

        // Mejora: Mostrar área durante el dibujo
        map.on(L.Draw.Event.DRAWVERTEX, (e) => {
            const layer = e.layer;
            if (layer instanceof L.Polygon) {
                const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                layer.bindTooltip(`Área actual: ${(area / 10000).toFixed(2)} ha`, {
                    permanent: true, 
                    direction: 'center'
                }).openTooltip();
            }
        });

        // Mejora: Búsqueda con autocompletado
        $(document).ready(function() {
            $('#buscadorFincas').select2({
                placeholder: "Escribe para buscar...",
                allowClear: true,
                data: datosFincas.map(f => ({
                    id: f.Codigo,
                    text: `${f.Codigo} - ${f.Finca}`
                }))
            }).on('change', function() {
                document.getElementById('codigoFinca').value = this.value;
                filtrarPorFinca();
            });
        });

        // Función mejorada de filtrado
        function filtrarPorFinca() {
            const codigoFinca = document.getElementById('codigoFinca').value;
            // ... (código existente de filtrado)
            
            // Mejora: Actualizar buscador Select2
            if (codigoFinca) {
                $('#buscadorFincas').val(codigoFinca).trigger('change');
            }
        }

        // ... (mantener resto de funciones existentes: cargarBosques, cargarCultivos, etc)
        
        // Función mejorada de leyenda dinámica
        function updateLegend(geojsonData) {
            // ... (código de leyenda existente mejorado)
            // Agregar elemento de área promedio
            div.innerHTML += `<hr><div><strong>Área promedio:</strong> ${calcularAreaPromedio()} ha</div>`;
        }

        // Nueva función: Cálculo de área promedio
        function calcularAreaPromedio() {
            const areas = datosFincaSeleccionada.map(f => parseFloat(f.Hectareas));
            return (areas.reduce((a, b) => a + b, 0) / areas.length).toFixed(2);
        }

        // Inicialización mejorada
        function init() {
            cargarBosques();
            cargarCultivos().then(() => {
                $('#buscadorFincas').trigger('change'); // Inicializar Select2
            });
            cargarFincas();
        }

        init();
    </script>
</body>
</html>
